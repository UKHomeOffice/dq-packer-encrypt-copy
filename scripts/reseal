<powershell>

# $EC2LaunchExe="C:\\Program Files\\Amazon\\EC2Launch\\EC2Launch.exe"
$EC2LaunchExe="$ENV:ProgramFiles\Amazon\EC2Launch\EC2Launch.exe"

# $EC2SettingsFile="C:\\Program Files\\Amazon\\Ec2ConfigService\\Settings\\Config.xml"
$EC2SettingsFile="$ENV:ProgramData\Amazon\EC2Launch\config\agent-config.yml"

$configContent = @"
version: 1.1
config:
  - stage: preReady
    tasks:
      - task: setAdminAccount
        inputs:
          password:
            type: random
      - task: setHostName
        inputs:
          reboot: true
      - task: executeScript
        inputs:
        - frequency: always
          type: powershell
          runAs: localSystem
          content: |-
            New-Item -Path 'C:\PowerShellTest.txt' -ItemType File
      - task: sysprep
        inputs:
          clean: true
          shutdown: true
"@

Set-Content -Path $EC2SettingsFile -Value $configContent

& $EC2LaunchExe reset --clean --block
& $EC2LaunchExe sysprep --clean --block --shutdown

</powershell>
